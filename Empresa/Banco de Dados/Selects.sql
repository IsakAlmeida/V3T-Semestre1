USE v3t;
SHOW TABLES;

-- SELECTS ATUALIZADOS -- 
-- KPI Umidade e Status do Sensor
    SELECT 
	s.idSensor as 'ID Sensor:',
    c.umidadePorcentagem AS 'Umidade (%)',
	CASE
		WHEN c.umidadePorcentagem > 60 THEN CONCAT('Acima do Limte! ',c.umidadePorcentagem,'%')
        WHEN c.umidadePorcentagem < 50 THEN CONCAT('Abaixo do Limte! ',c.umidadePorcentagem,'%')
        ELSE CONCAT('Ideal ', c.umidadePorcentagem,'%')
	END as 'Status Umidade (%):'
    FROM Captura as c
		RIGHT JOIN Sensor as s ON c.fkSensor = s.idSensor
        RIGHT JOIN Reservatorio AS r ON s.fkReservatorio = r.idReservatorio
		RIGHT JOIN Empresa as e ON r.fkEmpresa = e.idEmpresa
        WHERE r.idReservatorio = 3
	ORDER BY c.dtHora DESC;
    
    -- KPI Temperatura e Status do Sensor 
    SELECT 
	s.idSensor as 'ID Sensor:',
    c.temperaturaCelsius AS 'Temperatura (°C)',
	CASE 
		WHEN c.temperaturaCelsius > 25 THEN CONCAT('Acima do Limite! ',c.temperaturaCelsius,'°C')
		WHEN c.temperaturaCelsius < 15 THEN CONCAT('Abaixo do Limite! ',c.temperaturaCelsius,'°C')
		ELSE CONCAT('Ideal ',c.temperaturaCelsius,'°C')
	END as 'Status Temperatura (°C):'
    FROM Captura as c
		RIGHT JOIN Sensor as s ON c.fkSensor = s.idSensor
        RIGHT JOIN Reservatorio AS r ON s.fkReservatorio = r.idReservatorio
		RIGHT JOIN Empresa as e ON r.fkEmpresa = e.idEmpresa
        WHERE r.idReservatorio = 3
	ORDER BY c.dtHora DESC;
    
-- VIEWS --
-- KPI Umidade e Status do Sensor
CREATE VIEW vw_kpi_umidade AS
    SELECT 
	s.idSensor as 'ID Sensor:',
    c.umidadePorcentagem AS 'Umidade (%)',
	CASE
		WHEN c.umidadePorcentagem > 60 THEN CONCAT('Acima do Limte! ',c.umidadePorcentagem,'%')
        WHEN c.umidadePorcentagem < 50 THEN CONCAT('Abaixo do Limte! ',c.umidadePorcentagem,'%')
        ELSE CONCAT('Ideal ', c.umidadePorcentagem,'%')
	END as 'Status Umidade (%):'
    FROM Captura as c
		RIGHT JOIN Sensor as s ON c.fkSensor = s.idSensor
        RIGHT JOIN Reservatorio AS r ON s.fkReservatorio = r.idReservatorio
		RIGHT JOIN Empresa as e ON r.fkEmpresa = e.idEmpresa;

SELECT c.umidadePorcentagem FROM vw_kpi_umidade WHERE r.idReservatorio = 3 ORDER BY c.dtHora DESC;

-- KPI Temperatura e Status do Sensor 
CREATE VIEW vw_kpi_temperatura AS 
    SELECT 
	s.idSensor as 'ID Sensor:',
    c.temperaturaCelsius AS 'Temperatura (°C)',
	CASE 
		WHEN c.temperaturaCelsius > 25 THEN CONCAT('Acima do Limite! ',c.temperaturaCelsius,'°C')
		WHEN c.temperaturaCelsius < 15 THEN CONCAT('Abaixo do Limite! ',c.temperaturaCelsius,'°C')
		ELSE CONCAT('Ideal ',c.temperaturaCelsius,'°C')
	END as 'Status Temperatura (°C):'
    FROM Captura as c
		RIGHT JOIN Sensor as s ON c.fkSensor = s.idSensor
        RIGHT JOIN Reservatorio AS r ON s.fkReservatorio = r.idReservatorio
		RIGHT JOIN Empresa as e ON r.fkEmpresa = e.idEmpresa;
        
SELECT c.temperaturaCelsius FROM vw_kpi_temperatura WHERE r.idReservatorio = 3 ORDER BY c.dtHora DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

-- 1º SELECT: (VISÃO MACRO SENSORES DE UMA EMPRESA) EXIBE OS DADOS DE TEMPERATURA E UMIDADE DE UMA DETERMINADA EMPRESA, E RETORNA EM ORDEM DA LEITURA MAIS RECENTE SE ESTA DENTRO OU FORA DO LIMITE DEVIDO
SELECT 
	s.idSensor as 'ID Sensor:',
	CASE 
		WHEN r.Temperatura > 25 THEN CONCAT('Acima do Limite! ',r.Temperatura,'°C')
		WHEN r.Temperatura < 15 THEN CONCAT('Abaixo do Limite! ',r.Temperatura,'°C')
		ELSE CONCAT('Ideal ',r.Temperatura,'°C')
	END as 'Status Temperatura (°C):',
	CASE
		WHEN r.Umidade > 60 THEN CONCAT('Acima do Limte! ',r.Umidade,'%')
        WHEN r.Umidade < 50 THEN CONCAT('Abaixo do Limte! ',r.Umidade,'%')
        ELSE CONCAT('Ideal ', r.Umidade,'%')
	END as 'Status Umidade (%):',
	r.dtHora as 'Hora da Leitura:',
    s.locall as 'Localização Sensor:',
    e.NomeEmpresa as 'Empresa:'
FROM Registro as r
		RIGHT JOIN Sensor as s ON r.fkSensor = s.idSensor
		RIGHT JOIN Empresa as e ON s.fkEmpresa = e.idEmpresa
WHERE e.idEmpresa = 3
	ORDER BY r.dtHora DESC;

-- 2º SELECT: (VISÃO ESPECIFICA DE UM ÚNICO SENSOR E UMA ÚNICA EMPRESA ) EXIBE OS DADOS DE TEMPERATURA E UMIDADE, E RETORNA EM ORDEM DA LEITURA MAIS RECENTE SE ESTA DENTRO OU FORA DO LIMITE DEVIDO 

SELECT 
s.idSensor as 'ID Sensor:',
	CASE 
		WHEN r.Temperatura > 25 THEN CONCAT('Acima do Limite! ',r.Temperatura,'°C')
		WHEN r.Temperatura < 15 THEN CONCAT('Abaixo do Limite! ',r.Temperatura,'°C')
		ELSE CONCAT('Ideal ',r.Temperatura,'°C')
	END as 'Status Temperatura (°C):',
	CASE
		WHEN r.Umidade > 50 THEN CONCAT('Acima do Limte! ',r.Umidade,'%')
        WHEN r.Umidade < 30 THEN CONCAT('Abaixo do Limte! ',r.Umidade,'%')
        ELSE CONCAT('Ideal ', r.Umidade,'%')
	END as 'Status Umidade (%):',
	r.dtHora as 'Hora da Leitura:',
    s.locall as 'Localização Sensor:',
    e.NomeEmpresa as 'Empresa:'
FROM Registro as r
		JOIN Sensor as s ON r.fkSensor = s.idSensor
		JOIN Empresa as e ON s.fkEmpresa = e.idEmpresa
WHERE e.idEmpresa = 3 AND s.idSensor = 3
	ORDER BY r.dtHora ASC;
    

-- 3º SELECT: EXIBE UMA VISÃO MACRO DE TODAS OS USUÁRIOS CADASTRADOS E SUAS RESPECTIVAS EMPRESAS, PODENDO NICHAR E CRIAR UMA PESQUISA ESPECIFICA POR EMPRESA(BASTA TIRAR OS COMENTÁRIOS DO WHERE)

SELECT 
	u.NomeUsuario as 'Nome Usuário:',
	u.Email as 'Email Usuário:',
    e.NomeEmpresa as 'Empresa:',
    e.Email as 'Email Empresa:',
	CONCAT(ende.Cidade,'-',ende.UF) as 'Sede:'
FROM Usuario as u
		JOIN Empresa as e ON e.idEmpresa = u.fkEmpresa
        JOIN Endereco as ende ON e.fkEndereco = ende.idEndereco
-- WHERE e.idEmpresa = 1
    ORDER BY ende.UF DESC;
    
-- 4º SELECT: EXIBE UMA VISÃO MACRO DE TODAS AS EMPRESAS CADASTRADAS E SEUS DADOS PARA CONTATO OU EXIBE VERSÃO DADOS DE CONTATO DE EMPRESAS POR UMA DETERMINADA UF

SELECT 
	e.RazaoSocial as 'Razão Social:',
    e.CNPJ as 'CNPJ:',
    e.Email as'Email:',
    e.Telefone as 'Tel: ',
    e.Token as 'Código de Acesso:',
    CONCAT(ende.Logradouro,', ',ende.Numero,' CEP: ',ende.CEP,' | ',ende.Cidade,'-',ende.UF ) as 'Endereço:'
FROM Empresa as e
	JOIN Endereco as ende ON e.fkEndereco = ende.idEndereco;
-- WHERE ende.UF = 'SP'
-- ORDER BY ende.UF;           


-- KPIs: DASHBOARD MACRO
CREATE VIEW vw_kpis_macro AS
SELECT DAY(c.dtHora) as dia,
MAX(c.temperaturaCelsius) as maxTemp, 
MIN(c.temperaturaCelsius) as minTemp, 
MAX(c.umidadePorcentagem) maxUmid, 
MIN(c.umidadePorcentagem) as minUmid, 
COUNT(*) as numAlertas,
r.fkEmpresa
FROM HistoricoAlerta h
JOIN Captura c ON c.idCaptura = h.fkCaptura
JOIN Sensor s on c.fkSensor = s.idSensor
JOIN Reservatorio r ON s.fkReservatorio = r.idReservatorio
WHERE  DAY(c.dtHora) = DAY(current_date()) AND MONTH(c.dtHora) = MONTH(current_date())
GROUP BY DAY(c.dtHora), r.fkEmpresa;

-- HISTORICO: VIEW DE HISTORICO
CREATE VIEW vw_alertas_historico AS
SELECT r.idReservatorio, r.nome, r.locall, st.tipo,c.temperaturaCelsius, c.umidadePorcentagem, c.dtHora, e.idEmpresa 
FROM HistoricoAlerta h
JOIN Status st ON st.idStatus = h.fkStatus
JOIN Captura c ON h.fkCaptura = c.idCaptura
JOIN Sensor s ON s.idSensor = c.fkSensor
JOIN Reservatorio r ON r.idReservatorio = s.fkReservatorio
JOIN Empresa e ON e.idEmpresa = r.fkEmpresa
ORDER BY c.dtHora DESC;